"""
/bot/handlers/base.py
Server Monitoring System v4.12.1
Copyright (c) 2025 Aleksandr Sukhanov
License: MIT
Base handlers for Telegram bot
–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤
–í–µ—Ä—Å–∏—è: 4.12.1
–ê–≤—Ç–æ—Ä: –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –°—É—Ö–∞–Ω–æ–≤ (c)
–õ–∏—Ü–µ–Ω–∑–∏—è: MIT
–ë–∞–∑–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è Telegram –±–æ—Ç–∞
"""

from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import CallbackContext
from lib.logging import debug_log
from config.settings import DEBUG_MODE

class BaseHandlers:
    """–ë–∞–∑–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –±–æ—Ç–∞"""
    
    def __init__(self, config_manager=None):
        self.config_manager = config_manager
    
    def check_access(self, chat_id):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –±–æ—Ç—É"""
        try:
            if self.config_manager:
                chat_ids = self.config_manager.get_setting('CHAT_IDS', [])
            else:
                from config.settings import CHAT_IDS
                chat_ids = CHAT_IDS
            
            return str(chat_id) in chat_ids
        except Exception as e:
            debug_log(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞: {e}")
            return False
    
    def start_command(self, update: Update, context: CallbackContext):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
        if not self.check_access(update.effective_chat.id):
            if update.message:
                update.message.reply_text("‚õî –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–≥–æ –±–æ—Ç–∞")
            elif update.callback_query:
                update.callback_query.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤")
                if update.callback_query.message:
                    update.callback_query.edit_message_text("‚õî –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–≥–æ –±–æ—Ç–∞")
            return
        
        # –ó–∞–≥–ª—É—à–∫–∞ - —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –±—É–¥–µ—Ç –≤ menu/handlers.py
        from bot.menu.handlers import MenuHandlers
        menu_handlers = MenuHandlers(self.config_manager)
        return menu_handlers.show_main_menu(update, context)
    
    def help_command(self, update: Update, context: CallbackContext):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
        if not self.check_access(update.effective_chat.id):
            update.message.reply_text("‚õî –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–≥–æ –±–æ—Ç–∞")
            return
        
        help_text = (
            "ü§ñ *–ü–æ–º–æ—â—å –ø–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—É*\n\n"
            "*–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*\n"
            "‚Ä¢ `/start` - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n"
            "‚Ä¢ `/check` - –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤\n"
            "‚Ä¢ `/servers` - –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤\n"
            "‚Ä¢ `/control` - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º\n"
            "‚Ä¢ `/extensions` - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è–º–∏\n"
            "‚Ä¢ `/debug` - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–ª–∞–¥–∫–æ–π\n\n"
            "*–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:*\n"
            "‚Ä¢ `/diagnose_ssh <ip>` - –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è\n"
            "‚Ä¢ `/silent` - –°—Ç–∞—Ç—É—Å —Ç–∏—Ö–æ–≥–æ —Ä–µ–∂–∏–º–∞\n\n"
            "*–û—Ç—á–µ—Ç—ã:*\n"
            "‚Ä¢ `/report` - –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –æ—Ç—á–µ—Ç–∞\n"
            "‚Ä¢ `/stats` - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç—ã\n\n"
            "*–í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:*\n"
        )
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —á–µ—Ä–µ–∑ –º–µ–Ω–µ–¥–∂–µ—Ä —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π
        try:
            from extensions.extension_manager import extension_manager
            if extension_manager.is_extension_enabled('web_interface'):
                help_text += "üåê http://192.168.20.2:5000\n"
                help_text += "_*–¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏_\n\n"
            else:
                help_text += "üî¥ –í –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è –æ—Ç–∫–ª—é—á–µ–Ω\n\n"
        except ImportError:
            help_text += "üî¥ –ú–æ–¥—É–ª—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω\n\n"
        
        help_text += "*–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è*"
        
        update.message.reply_text(help_text, parse_mode='Markdown')
    
    def error_handler(self, update: Update, context: CallbackContext):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫"""
        error_text = f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {context.error}"
        debug_log(f"–û—à–∏–±–∫–∞ –≤ –±–æ—Ç–µ: {context.error}")
        
        # –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        try:
            if update and update.effective_chat:
                update.effective_chat.send_message(
                    "‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–æ–º–∞–Ω–¥—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
                )
        except:
            pass
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Å–µ—Ä—å–µ–∑–Ω—ã—Ö –æ—à–∏–±–æ–∫
        import traceback
        debug_log(f"Traceback: {traceback.format_exc()}")