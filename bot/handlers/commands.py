"""
/bot/handlers/commands.py
Server Monitoring System v4.13.1
Copyright (c) 2025 Aleksandr Sukhanov
License: MIT
Command handlers
–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤
–í–µ—Ä—Å–∏—è: 4.13.1
–ê–≤—Ç–æ—Ä: –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –°—É—Ö–∞–Ω–æ–≤ (c)
–õ–∏—Ü–µ–Ω–∑–∏—è: MIT
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
"""

from telegram import InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import CommandHandler
from bot.handlers.base import base_handler, check_access
from bot.menu.builder import menu_builder
from lib.logging import debug_log

@base_handler.access_check_decorator
def start_command(update, context):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    debug_log("–í—ã–∑–≤–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ /start")
    return menu_builder.show_main_menu(update, context)

@base_handler.access_check_decorator
def help_command(update, context):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
    help_text = (
        "ü§ñ *–ü–æ–º–æ—â—å –ø–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—É*\n\n"
        "*–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*\n"
        "‚Ä¢ `/start` - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n"
        "‚Ä¢ `/check` - –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤\n"
        "‚Ä¢ `/servers` - –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤\n"
        "‚Ä¢ `/control` - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º\n"
        "‚Ä¢ `/extensions` - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è–º–∏\n"
        "‚Ä¢ `/debug` - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–ª–∞–¥–∫–æ–π\n\n"
        "*–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:*\n"
        "‚Ä¢ `/diagnose_ssh <ip>` - –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è\n"
        "‚Ä¢ `/silent` - –°—Ç–∞—Ç—É—Å —Ç–∏—Ö–æ–≥–æ —Ä–µ–∂–∏–º–∞\n\n"
        "*–û—Ç—á–µ—Ç—ã:*\n"
        "‚Ä¢ `/report` - –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –æ—Ç—á–µ—Ç–∞\n"
        "‚Ä¢ `/stats` - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç—ã\n\n"
        "*–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è*"
    )
    
    update.message.reply_text(help_text, parse_mode='Markdown')

@base_handler.access_check_decorator
def check_command(update, context):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /check"""
    from core.monitor import manual_check_handler
    return manual_check_handler(update, context)

@base_handler.access_check_decorator
def status_command(update, context):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /status"""
    from core.monitor import monitor_status
    return monitor_status(update, context)

@base_handler.access_check_decorator
def silent_command(update, context):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /silent"""
    from core.monitor import silent_command
    return silent_command(update, context)

@base_handler.access_check_decorator
def control_command(update, context):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /control"""
    from core.monitor import control_command
    return control_command(update, context)

@base_handler.access_check_decorator
def servers_command(update, context):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /servers"""
    # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    from extensions.server_checks import servers_command
    return servers_command(update, context)

@base_handler.access_check_decorator
def report_command(update, context):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /report"""
    from modules.morning_report import send_morning_report_handler
    return send_morning_report_handler(update, context)

@base_handler.access_check_decorator
def stats_command(update, context):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /stats"""
    from extensions.utils import stats_command
    return stats_command(update, context)

@base_handler.access_check_decorator
def diagnose_ssh_command(update, context):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /diagnose_ssh"""
    from extensions.utils import diagnose_ssh_command
    return diagnose_ssh_command(update, context)

@base_handler.access_check_decorator
def extensions_command(update, context):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /extensions"""
    from extensions.extension_manager import show_extensions_menu
    return show_extensions_menu(update, context)

@base_handler.access_check_decorator
def debug_command(update, context):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /debug"""
    from bot.menu.handlers import show_debug_menu
    return show_debug_menu(update, context)

@base_handler.access_check_decorator
def backup_command(update, context):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /backup"""
    from extensions.extension_manager import extension_manager
    
    if not extension_manager.is_extension_enabled('backup_monitor'):
        update.message.reply_text(
            "‚ùå –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –±—ç–∫–∞–ø–æ–≤ –æ—Ç–∫–ª—é—á–µ–Ω. "
            "–í–∫–ª—é—á–∏—Ç–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ 'üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –±—ç–∫–∞–ø–æ–≤ Proxmox' –≤ —Ä–∞–∑–¥–µ–ª–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è–º–∏.",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("üõ†Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è–º–∏", callback_data='extensions_menu')]
            ])
        )
        return
    
    from extensions.backup_monitor.bot_handler import backup_command
    return backup_command(update, context)

def get_command_handlers():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥"""
    return [
        CommandHandler("start", start_command),
        CommandHandler("help", help_command),
        CommandHandler("check", check_command),
        CommandHandler("status", status_command),
        CommandHandler("servers", servers_command),
        CommandHandler("silent", silent_command),
        CommandHandler("report", report_command),
        CommandHandler("stats", stats_command),
        CommandHandler("control", control_command),
        CommandHandler("diagnose_ssh", diagnose_ssh_command),
        CommandHandler("extensions", extensions_command),
        CommandHandler("debug", debug_command),
        CommandHandler("backup", backup_command),
        CommandHandler("backup_search", backup_search_command),
        CommandHandler("backup_help", backup_help_command),
    ]

# –í—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–≥–ª—É—à–∫–∏ –¥–ª—è –∫–æ–º–∞–Ω–¥ –±—ç–∫–∞–ø–æ–≤
@base_handler.access_check_decorator
def backup_search_command(update, context):
    """–í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è /backup_search"""
    from extensions.extension_manager import extension_manager
    
    if not extension_manager.is_extension_enabled('backup_monitor'):
        update.message.reply_text(
            "‚ùå –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –±—ç–∫–∞–ø–æ–≤ –æ—Ç–∫–ª—é—á–µ–Ω."
        )
        return
    
    update.message.reply_text("üîç –ü–æ–∏—Å–∫ –±—ç–∫–∞–ø–æ–≤ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")

@base_handler.access_check_decorator
def backup_help_command(update, context):
    """–í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è /backup_help"""
    from extensions.extension_manager import extension_manager
    
    if not extension_manager.is_extension_enabled('backup_monitor'):
        update.message.reply_text(
            "‚ùå –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –±—ç–∫–∞–ø–æ–≤ –æ—Ç–∫–ª—é—á–µ–Ω."
        )
        return
    
    update.message.reply_text("‚ùì –ü–æ–º–æ—â—å –ø–æ –±—ç–∫–∞–ø–∞–º –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞")