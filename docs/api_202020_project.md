# API 202020 — подробный план первого этапа

## Этап 1. Проектирование BFF-контрактов (2–3 рабочих дня)

Цель этапа: зафиксировать **что именно Android получает от BFF**, **как BFF ходит во внутренние сервисы**, и какие нефункциональные ограничения обязательны (SLO/таймауты/ошибки). На выходе должна быть согласованная база, чтобы дальше в разработке не началась хаотичная переделка контрактов.

---

## 1) Что входит в этап

1. Отбор 5–10 приоритетных Android-сценариев для первой поставки.
2. Проектирование внешнего контракта BFF (REST/gRPC, формат ответов и ошибок).
3. Проектирование внутренних контрактов BFF -> сервисы (proto, idempotency, retries).
4. Фиксация нефункциональных требований (SLO, timeout budget, fallback-стратегии).
5. Подготовка backlog для следующего этапа (каркас + вертикальный срез).

---

## 2) Роли и ответственность

> Дополнительная вводная: проект ведёт один человек, который совмещает все роли ниже и несёт итоговую ответственность за решения и результат.

- **Backend/BFF инженер**: лидер по контрактам BFF, ограничениями по payload и timeout budget.
- **Android инженер**: подтверждает удобство полей/ошибок, требования по версиям API.
- **Сервисные команды (владельцы gRPC сервисов)**: согласуют внутренние proto и SLA.
- **QA/автотесты**: формализуют acceptance-критерии для контрактных тестов.
- **Техлид/архитектор**: финальное решение по спорным кейсам и DoD.

### Как работать в соло-режиме (без потери качества)

Чтобы не скатиться в хаос, один исполнитель последовательно «переключает шапки»:

1. **Продукт + Android взгляд** — сначала фиксируем пользовательскую ценность и минимальный payload.
2. **BFF/backend взгляд** — затем проектируем endpoint, ошибки, ограничения по timeout.
3. **Внутренние сервисы взгляд** — проверяем реалистичность gRPC-контрактов и зависимостей.
4. **QA взгляд** — формулируем проверяемые acceptance-критерии.
5. **Техлид взгляд** — в конце дня делаем self-review и принимаем финальные решения.

Правило: пока не пройден чек-лист текущей «шапки», к следующей не переходим.

---

## 3) Детальный план по дням

### День 1 — сценарии и границы

Ниже — подробный порядок действий «с нуля до артефакта», если стартуем прямо сегодня.

#### Шаг 0. Подготовка рабочего контура (30–45 минут)

1. Создать рабочие файлы:
   - `docs/contracts/external_bff_api.md`;
   - `docs/contracts/error_mapping.md`;
   - `docs/backlog/stage2_vertical_slice.md`.
2. В каждом файле сразу зафиксировать секцию `Status: Draft` и `Last updated`.
3. Добавить в `docs/api_202020_project.md` ссылку на эти артефакты (чтобы всё было в одном месте).

**Результат шага:** есть «каркас документации», можно заполнять без метаний.

#### Шаг 1. Собрать кандидаты сценариев (60–90 минут)

1. Выписать все пользовательские сценарии, которые точно нужны в первом релизе (обычно 10–15 штук).
2. Для каждого сценария заполнить мини-карточку:
   - `Название`;
   - `Пользовательская цель`;
   - `Триггер на клиенте` (экран/действие);
   - `Критичность` (влияет ли на core-flow).
3. Схлопнуть дубли и пересечения (часто часть сценариев можно объединить).

**Результат шага:** черновой список сценариев без приоритета.

#### Шаг 2. Приоритизация в P0/P1 (45–60 минут)

1. Ввести простые правила:
   - `P0`: без этого сценария релиз теряет смысл;
   - `P1`: полезно, но может подождать после первого вертикального среза.
2. Оценить каждый сценарий по двум осям:
   - бизнес-обязательность;
   - технический риск/объём.
3. Отобрать 5–10 сценариев (цель: 5–7 в `P0`, остальные в `P1`).

**Результат шага:** финальный список сценариев первой поставки.

#### Шаг 3. Описать вход/выход/ошибки по каждому сценарию (2–3 часа)

Для каждого `P0` сценария заполнить шаблон:

1. **Вход:**
   - метод/endpoint;
   - path/query/body параметры;
   - обязательные заголовки;
   - auth context.
2. **Выход:**
   - минимальный набор полей (без «про запас»);
   - nullable/non-null;
   - правила сортировки/пагинации (если нужно).
3. **Ошибки:**
   - бизнес-ошибки;
   - транспортные (timeout/unavailable/invalid argument);
   - ожидаемый код и message для клиента.

**Результат шага:** у каждого `P0` сценария есть чёткий черновой контракт.

#### Шаг 4. Самопроверка по ролям (60 минут)

1. **Android-проверка:** удобно ли клиенту, нет ли лишних полей, хватает ли данных для экрана.
2. **BFF-проверка:** нет ли слишком тяжёлых ответов, адекватны ли лимиты и pagination.
3. **Сервисная проверка:** реалистично ли получить данные из текущих downstream.
4. **QA-проверка:** есть ли для каждого сценария явные acceptance-критерии.

**Результат шага:** согласованный самим с собой (и документально зафиксированный) baseline без дыр.

#### Шаг 5. Зафиксировать артефакт дня и «завтрашний вход» (30 минут)

1. Собрать итоговую таблицу сценариев с полями:
   - `Scenario`;
   - `Priority (P0/P1)`;
   - `Endpoint draft`;
   - `Downstream draft`;
   - `Main errors`;
   - `Open questions`.
2. Для каждого открытого вопроса назначить статус: `решить на Дне 2` или `вынести в backlog`.
3. В конце документа добавить блок «Что делаем в первую очередь завтра» (3–5 пунктов).

**Результат шага:** День 1 закрыт, на День 2 есть чёткая стартовая точка.

1. Собрать и приоритизировать 5–10 пользовательских сценариев Android:
   - авторизация/рефреш токена;
   - профиль;
   - список сущностей;
   - детали сущности;
   - action-операции (создать/обновить/подтвердить и т.д.).
2. Для каждого сценария зафиксировать:
   - вход (параметры, заголовки, auth context);
   - выход (минимально нужные поля);
   - ошибки (бизнес + транспорт).
3. Проставить приоритеты: `P0` (обязательно для первого релиза), `P1` (можно после вертикального среза).

**Артефакт дня:** таблица сценариев с приоритетом и черновыми контрактами.

### День 2 — внешние и внутренние контракты

1. Спроектировать **внешний контракт BFF**:
   - endpoint naming/версионирование (`/v1/...`);
   - единый envelope ошибок (`code`, `message`, `request_id`, `details`);
   - пагинация/фильтрация/сортировка;
   - требования к backward compatibility.
2. Спроектировать **внутренний контракт BFF -> gRPC**:
   - proto messages и rpc;
   - retry semantics (какие вызовы можно безопасно повторять);
   - idempotency ключи для write-операций;
   - mapping бизнес-ошибок в внешний формат BFF.
3. Согласовать с Android + сервисными командами и собрать список расхождений.

**Артефакт дня:** пакет контрактов (OpenAPI/описание endpoint + proto draft + матрица ошибок).

### День 3 — нефункционал, риски и backlog

1. Зафиксировать SLO/SLI:
   - latency: p50/p95/p99 на ключевые endpoint;
   - error rate;
   - доступность BFF.
2. Разложить timeout budget по цепочке:
   - Android -> BFF;
   - BFF -> gRPC сервис #1/#2;
   - общий дедлайн запроса.
3. Определить деградации:
   - fallback ответы;
   - частичное заполнение payload;
   - поведение при timeout одного из downstream.
4. Сформировать backlog на Этап 2:
   - задачи на каркас BFF;
   - приоритетные 2–3 endpoint для вертикального среза;
   - контрактные тесты и проверки observability.

**Артефакт дня:** финальный документ этапа + задачник следующего этапа.

---

## 4) Формат артефактов (чтобы не было бардака)

1. `docs/contracts/external_bff_api.md` — внешние endpoint и примеры ответов.
2. `docs/contracts/internal_grpc_contracts.md` — соответствие endpoint -> rpc.
3. `docs/contracts/error_mapping.md` — карта ошибок (downstream -> BFF).
4. `docs/contracts/slo_timeout_budget.md` — SLO и таймауты.
5. `docs/backlog/stage2_vertical_slice.md` — задачи на следующий этап.

Если форматы уже есть в репозитории, используем существующие шаблоны и просто дополняем.

---

## 5) Definition of Done (DoD) для Этапа 1

Этап считается завершенным, если:

1. Утверждены 5–10 сценариев с приоритетами `P0/P1`.
2. Внешние контракты BFF согласованы с Android командой.
3. Внутренние gRPC контракты согласованы с владельцами сервисов.
4. Есть единый формат ошибок и mapping для всех P0 сценариев.
5. Зафиксированы SLO и timeout budget на P0 сценарии.
6. Сформирован backlog Этапа 2 с оценками и зависимостями.

---

## 6) Основные риски и как их заранее прибить

1. **Риск:** Android просит изменить payload уже после старта реализации.
   - **Митигировать:** раннее согласование примеров JSON и обязательный sign-off от Android.
2. **Риск:** внутренние сервисы не готовы к нужным полям/методам.
   - **Митигировать:** зафиксировать gap-list в конце Дня 2 и назначить владельцев.
3. **Риск:** не укладываемся в latency из-за каскада вызовов.
   - **Митигировать:** ограничить fan-out, ввести timeout budget и деградационный режим.
4. **Риск:** разнобой в кодах ошибок.
   - **Митигировать:** единая таблица error mapping + обязательные контрактные тесты.

---

## 7) Короткий operational checklist на старт Этапа 2

- [ ] У всех P0 endpoint есть согласованный контракт и примеры.
- [ ] У всех P0 сценариев есть mapping в конкретные gRPC вызовы.
- [ ] В error mapping нет «TBD» по критичным кейсам.
- [ ] SLO/timeout budget подписаны техлидом.
- [ ] Backlog вертикального среза содержит владельца и оценку по каждой задаче.

После этого можно безопасно переходить к реализации каркаса BFF и первому e2e срезу.
