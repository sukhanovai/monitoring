# API 202020 — подробный план первого этапа

## Этап 1. Проектирование BFF-контрактов (2–3 рабочих дня)

Цель этапа: зафиксировать **что именно Android получает от BFF**, **как BFF ходит во внутренние сервисы**, и какие нефункциональные ограничения обязательны (SLO/таймауты/ошибки). На выходе должна быть согласованная база, чтобы дальше в разработке не началась хаотичная переделка контрактов.

---

## 1) Что входит в этап

1. Отбор 5–10 приоритетных Android-сценариев для первой поставки.
2. Проектирование внешнего контракта BFF (REST/gRPC, формат ответов и ошибок).
3. Проектирование внутренних контрактов BFF -> сервисы (proto, idempotency, retries).
4. Фиксация нефункциональных требований (SLO, timeout budget, fallback-стратегии).
5. Подготовка backlog для следующего этапа (каркас + вертикальный срез).

---

## 2) Роли и ответственность

- **Backend/BFF инженер**: лидер по контрактам BFF, ограничениями по payload и timeout budget.
- **Android инженер**: подтверждает удобство полей/ошибок, требования по версиям API.
- **Сервисные команды (владельцы gRPC сервисов)**: согласуют внутренние proto и SLA.
- **QA/автотесты**: формализуют acceptance-критерии для контрактных тестов.
- **Техлид/архитектор**: финальное решение по спорным кейсам и DoD.

---

## 3) Детальный план по дням

### День 1 — сценарии и границы

1. Собрать и приоритизировать 5–10 пользовательских сценариев Android:
   - авторизация/рефреш токена;
   - профиль;
   - список сущностей;
   - детали сущности;
   - action-операции (создать/обновить/подтвердить и т.д.).
2. Для каждого сценария зафиксировать:
   - вход (параметры, заголовки, auth context);
   - выход (минимально нужные поля);
   - ошибки (бизнес + транспорт).
3. Проставить приоритеты: `P0` (обязательно для первого релиза), `P1` (можно после вертикального среза).

**Артефакт дня:** таблица сценариев с приоритетом и черновыми контрактами.

### День 2 — внешние и внутренние контракты

1. Спроектировать **внешний контракт BFF**:
   - endpoint naming/версионирование (`/v1/...`);
   - единый envelope ошибок (`code`, `message`, `request_id`, `details`);
   - пагинация/фильтрация/сортировка;
   - требования к backward compatibility.
2. Спроектировать **внутренний контракт BFF -> gRPC**:
   - proto messages и rpc;
   - retry semantics (какие вызовы можно безопасно повторять);
   - idempotency ключи для write-операций;
   - mapping бизнес-ошибок в внешний формат BFF.
3. Согласовать с Android + сервисными командами и собрать список расхождений.

**Артефакт дня:** пакет контрактов (OpenAPI/описание endpoint + proto draft + матрица ошибок).

### День 3 — нефункционал, риски и backlog

1. Зафиксировать SLO/SLI:
   - latency: p50/p95/p99 на ключевые endpoint;
   - error rate;
   - доступность BFF.
2. Разложить timeout budget по цепочке:
   - Android -> BFF;
   - BFF -> gRPC сервис #1/#2;
   - общий дедлайн запроса.
3. Определить деградации:
   - fallback ответы;
   - частичное заполнение payload;
   - поведение при timeout одного из downstream.
4. Сформировать backlog на Этап 2:
   - задачи на каркас BFF;
   - приоритетные 2–3 endpoint для вертикального среза;
   - контрактные тесты и проверки observability.

**Артефакт дня:** финальный документ этапа + задачник следующего этапа.

---

## 4) Формат артефактов (чтобы не было бардака)

1. `docs/contracts/external_bff_api.md` — внешние endpoint и примеры ответов.
2. `docs/contracts/internal_grpc_contracts.md` — соответствие endpoint -> rpc.
3. `docs/contracts/error_mapping.md` — карта ошибок (downstream -> BFF).
4. `docs/contracts/slo_timeout_budget.md` — SLO и таймауты.
5. `docs/backlog/stage2_vertical_slice.md` — задачи на следующий этап.

Если форматы уже есть в репозитории, используем существующие шаблоны и просто дополняем.

---

## 5) Definition of Done (DoD) для Этапа 1

Этап считается завершенным, если:

1. Утверждены 5–10 сценариев с приоритетами `P0/P1`.
2. Внешние контракты BFF согласованы с Android командой.
3. Внутренние gRPC контракты согласованы с владельцами сервисов.
4. Есть единый формат ошибок и mapping для всех P0 сценариев.
5. Зафиксированы SLO и timeout budget на P0 сценарии.
6. Сформирован backlog Этапа 2 с оценками и зависимостями.

---

## 6) Основные риски и как их заранее прибить

1. **Риск:** Android просит изменить payload уже после старта реализации.
   - **Митигировать:** раннее согласование примеров JSON и обязательный sign-off от Android.
2. **Риск:** внутренние сервисы не готовы к нужным полям/методам.
   - **Митигировать:** зафиксировать gap-list в конце Дня 2 и назначить владельцев.
3. **Риск:** не укладываемся в latency из-за каскада вызовов.
   - **Митигировать:** ограничить fan-out, ввести timeout budget и деградационный режим.
4. **Риск:** разнобой в кодах ошибок.
   - **Митигировать:** единая таблица error mapping + обязательные контрактные тесты.

---

## 7) Короткий operational checklist на старт Этапа 2

- [ ] У всех P0 endpoint есть согласованный контракт и примеры.
- [ ] У всех P0 сценариев есть mapping в конкретные gRPC вызовы.
- [ ] В error mapping нет «TBD» по критичным кейсам.
- [ ] SLO/timeout budget подписаны техлидом.
- [ ] Backlog вертикального среза содержит владельца и оценку по каждой задаче.

После этого можно безопасно переходить к реализации каркаса BFF и первому e2e срезу.
